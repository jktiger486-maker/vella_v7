# PIT-1 : VELLA_V7 ARCHITECTURE (MODULE & CONTRACT)

========================================================
이 문서는 "코드를 어떻게 짜라"가 아니다.
❗️"어디까지 생각하고, 어디서 멈춰야 하는가"를 고정하는 문서다.
========================================================


## 0. 목적 (WHY THIS EXISTS)

[목적]
- V3의 가장 큰 실패 원인인 **강결합 구조**를 원천 차단
- V4에서 얻은 "섹션 분리 사고"를 **완전한 계약 기반 구조**로 승격
- V7에서
  👉 한 모듈을 바꿔도
  👉 다른 모듈을 전혀 건드리지 않게 만들기 위함

[이 문서의 지위]
- ❌ 구현 설명서 아님
- ❌ 전략 문서 아님
- ✅ **설계 헌법**
- ✅ PIT-0 다음 단계의 “구조 고정 선언문”


--------------------------------------------------------


## 1. V7 핵심 구조 원칙 (절대 규칙)

### 1-1. 모듈 독립 원칙 (Hard Rule)

- 모든 모듈은 **단독으로 이해 가능**해야 한다.
- 어떤 모듈도:
  - 다른 모듈의 내부 로직
  - 다른 모듈의 변수
  - 다른 모듈의 상태 구조
  를 **직접 참조하면 즉시 설계 위반**이다.

👉 연결은 오직 **Contract(계약)** 로만 한다.


### 1-2. 판단 / 실행 분리 원칙

- 판단(Decision)과 실행(Execution)은 **절대 같은 모듈에 존재하지 않는다**.
- 이 원칙이 깨지는 순간:
  → V3처럼 “고치면 다 터지는 구조”가 된다.


--------------------------------------------------------


## 2. VELLA_V7 MODULE MAP (최종 확정)

아래 모듈 목록은 **추가 가능 / 삭제 가능**하지만  
❗️역할 혼합은 절대 금지다.

vella_v7/
├─ context/ # 시장 상태 / 레짐 / 환경 인식
├─ entry/ # 진입 판단 전용
├─ exit/ # 청산 판단 전용
├─ risk/ # 손절, 비중, 리스크 계산
├─ state/ # 포지션 상태 저장 (판단 금지)
├─ execution/ # 실제 주문 실행 (전략 판단 금지)
├─ cfg/ # 설정 로딩 & 검증 (로직 없음)
├─ data/ # 시세·봉 데이터 수집 (판단 금지)
├─ contract/ # 모듈 간 인터페이스 정의 (핵심)
└─ app/ # 오케스트레이터 (조립만 담당)


[중요]
- 이 구조를 바꾸는 순간
  → **PIT-1부터 수정**
- 코드만 고쳐서 우회 ❌


------------------------------------------------------------


## 3. 모듈 공통 절대 규칙 (ALL MODULES)

### 3-1. 모듈 독립 원칙

- 모든 모듈은 **단독으로 이해 가능**해야 한다.
- 아래 행위는 즉시 설계 위반이다:
  - 다른 모듈의 내부 변수 접근
  - 다른 모듈의 로직 직접 호출
  - 다른 모듈의 상태 객체 직접 수정

👉 모듈 간 통신은  
👉 **contract 모듈에 정의된 인터페이스만 허용**


### 3-2. 판단 / 실행 완전 분리 원칙

- 판단(Decision)과 실행(Execution)은
  **절대 같은 모듈에 존재할 수 없다.**

👉 판단 = 두뇌  
👉 실행 = 손발  
👉 이 둘이 섞이는 순간 V3로 회귀


------------------------------------------------------------


## 4. MODULE별 책임 경계 (CAN / CANNOT)

이 섹션은 **벨라와 주인님 모두를 묶는 족쇄**다.


### 4-1. context (환경 인식)

[할 수 있는 것]
- 시장 상태 판단
- BTC Regime 계산
- 시간/세션/환경 ON-OFF 판단

[절대 못 하는 것]
- 진입 판단 ❌
- 청산 판단 ❌
- 주문 실행 ❌
- 포지션 상태 변경 ❌

👉 context = “지금 시장이 어떤 상태인가”만 말함


------------------------------------------------------------


### 4-2. entry (진입 판단)

[할 수 있는 것]
- 진입 조건 판단
- Entry Signal 생성

[절대 못 하는 것]
- 주문 실행 ❌
- 상태 저장 ❌
- 손절/청산 계산 ❌

👉 entry = YES / NO + 이유만 제공


------------------------------------------------------------


### 4-3. exit (청산 판단)

[할 수 있는 것]
- SL / TP / Trailing / Regime Exit 판단
- Exit Signal 생성

[절대 못 하는 것]
- 주문 실행 ❌
- 수량 계산 ❌
- 상태 저장 ❌

👉 exit = “나가야 한다”는 판단만 담당


------------------------------------------------------------


### 4-4. risk (리스크 계산)

[할 수 있는 것]
- 손절 가격 계산
- 포지션 수량 계산
- 리스크 한도 계산

[절대 못 하는 것]
- 진입 판단 ❌
- 청산 판단 ❌
- 주문 실행 ❌

👉 risk = 숫자만 계산하는 계산기


------------------------------------------------------------


### 4-5. state (상태 저장)

[할 수 있는 것]
- 포지션 상태 저장
- 재시작 시 상태 복원

[절대 못 하는 것]
- 판단 ❌
- 계산 ❌
- 주문 ❌

👉 state = 기억만 한다. 생각하지 않는다.


------------------------------------------------------------


### 4-6. execution (실행)

[할 수 있는 것]
- 주문 전송
- 체결 결과 수신

[절대 못 하는 것]
- 전략 판단 ❌
- 조건 해석 ❌

👉 execution = 손과 발


------------------------------------------------------------


### 4-7. cfg (설정)

[할 수 있는 것]
- 설정 로딩
- 타입/범위 검증
- ON/OFF 스위치 제공

[절대 못 하는 것]
- 전략 판단 ❌
- 계산 ❌

👉 cfg = 다이얼이지 두뇌가 아니다


------------------------------------------------------------


### 4-8. data (데이터 수집)

[할 수 있는 것]
- 실시간 시세 수집
- 봉 데이터 수집

[절대 못 하는 것]
- 판단 ❌
- 지표 해석 ❌

👉 data = 원재료 공급자


------------------------------------------------------------


### 4-9. contract (계약 정의)

[역할]
- 모든 모듈 간 데이터 구조 정의
- 이 폴더를 통하지 않으면
  ❌ 어떤 모듈도 서로 통신 불가

👉 V7의 심장
👉 여기 흔들리면 전부 무효


------------------------------------------------------------


### 4-10. app (오케스트레이터)

[할 수 있는 것]
- 모듈 호출 순서 조립
- Signal 전달

[절대 못 하는 것]
- 전략 판단 ❌
- 계산 ❌

👉 app = 지휘자, 연주자 아님


------------------------------------------------------------


## 5. V7 구조 최종 선언 (요약)

- V7의 목표는 “잘 짠 코드”가 아니다.
- 목표는:
  ✔ 잘못 고쳐도 안 망가지는 구조
  ✔ 하나를 버려도 전체가 유지되는 구조
  ✔ 벨라가 추정하지 못하는 구조

이 문서 이후:
- ❌ “이 로직을 어디에 넣지?” 금지
- ✅ “이 책임은 어떤 모듈의 것인가?”만 허용

============================================================


