# CODEGEN-16 : STATE TRANSITION v1 (SINGLE GATE)

## ëª©ì 
ì´ ë¬¸ì„œëŠ” VELLA_V7ì—ì„œ **ìƒíƒœ(State)ê°€ ë³€ê²½ë  ìˆ˜ ìˆëŠ”
ìœ ì¼í•œ í†µë¡œ(State Transition Gate)** ë¥¼ ì •ì˜í•œë‹¤.

ì›ì¹™:
- íŒë‹¨ âŒ
- ê³„ì‚° âŒ
- ì „ëµ âŒ
- ì˜¤ì§ "Signal â†’ State ë°˜ì˜"ë§Œ ìˆ˜í–‰

ğŸ‘‰ State ì˜¤ì—¼ì„ êµ¬ì¡°ì ìœ¼ë¡œ ì°¨ë‹¨í•œë‹¤.


============================================================
## 0. ë³€ê²½ ëŒ€ìƒ
============================================================

vella_v7/modules/state/transition.py


- PIT-5 (State rule) ì ˆëŒ€ ì¤€ìˆ˜
- PIT-6 (Signal contract) ì ˆëŒ€ ì¤€ìˆ˜
- Entry / Exit / Risk íŒë‹¨ ì¹¨ë²” âŒ
- Execution í˜¸ì¶œ âŒ


============================================================
## 1. ì„¤ê³„ í•µì‹¬ (ì£¼ì¸ë‹˜ í™•ì¸ìš©)
============================================================

- Entry / Exit / Risk ëª¨ë“ˆì€ **Signalë§Œ ë°˜í™˜**
- State ë³€ê²½ì€ ì´ íŒŒì¼ì—ì„œë§Œ í—ˆìš©
- ëª¨ë“  Signalì€ **ëª…ì‹œì  ë¶„ê¸°**ë¡œ ì²˜ë¦¬
- ì•”ë¬µì  ì²˜ë¦¬ / ìë™ ì²˜ë¦¬ / í¸ì˜ ë¡œì§ âŒ


============================================================
## 2. transition.py (FULL CONTENT)
============================================================

```python
# ============================================================
# AUTO-GENERATED FILE â€” DO NOT EDIT MANUALLY
# SOURCE OF TRUTH: PIT-5, PIT-6, CODEGEN-16
# ============================================================

from typing import Optional
from vella_v7.contracts.contracts import (
    EngineState,
    EntrySignal,
    ExitSignal,
    RiskSignal,
)


def apply_signal_to_state(
    state: EngineState,
    entry_signal: Optional[EntrySignal] = None,
    exit_signal: Optional[ExitSignal] = None,
    risk_signal: Optional[RiskSignal] = None,
) -> EngineState:
    """
    Single State Transition Gate (v1)

    Rules:
    - One signal type at a time
    - Explicit branching
    - No implicit mutation
    """

    # --------------------------------------------------------
    # Copy state (immutability guarantee)
    # --------------------------------------------------------
    new_state = state.copy()

    # --------------------------------------------------------
    # Entry Signal
    # --------------------------------------------------------
    if entry_signal is not None:
        if new_state.has_position:
            return new_state  # ignore illegal entry

        new_state.has_position = True
        new_state.side = entry_signal.side
        new_state.entry_price = entry_signal.price
        new_state.entry_time = entry_signal.timestamp
        new_state.tp1_filled = False
        new_state.trailing_active = False
        new_state.remaining_qty = entry_signal.qty

        return new_state

    # --------------------------------------------------------
    # Exit Signal
    # --------------------------------------------------------
    if exit_signal is not None:
        if not new_state.has_position:
            return new_state  # nothing to exit

        new_state.has_position = False
        new_state.side = None
        new_state.entry_price = None
        new_state.entry_time = None
        new_state.tp1_filled = False
        new_state.trailing_active = False
        new_state.remaining_qty = 0.0

        return new_state

    # --------------------------------------------------------
    # Risk Signal
    # --------------------------------------------------------
    if risk_signal is not None:
        # v1: risk does NOT mutate state
        # reserved for future escalation rules
        return new_state

    # --------------------------------------------------------
    # No signal
    # --------------------------------------------------------
    return new_state


============================================================

3. ì˜ë„ì  ì œì•½ (ì¤‘ìš”)

============================================================

ìë™ ì „ì´ âŒ

ë‹¤ì¤‘ Signal ë³‘í•© âŒ

State ì§ì ‘ ìˆ˜ì • âŒ

Execution ì—°ë™ âŒ

StateëŠ” íŒë‹¨í•˜ì§€ ì•Šê³ ,
Signalë§Œ ë°˜ì˜í•œë‹¤.

============================================================

4. ì‹¤íŒ¨ ë°©ì§€ ì²´í¬ë¦¬ìŠ¤íŠ¸

============================================================

ì•„ë˜ê°€ ë³´ì´ë©´ ì¦‰ì‹œ êµ¬ì¡° ë¶•ê´´ë‹¤.

state.has_position = True ë¥¼ ë‹¤ë¥¸ íŒŒì¼ì—ì„œ ìˆ˜í–‰

íŒë‹¨ if/else ê°€ State ì•ˆì— ì¡´ì¬

RiskSignalì´ Exitì„ ê°•ì œ

ğŸ‘‰ ì „ë¶€ ìœ„ë°˜

============================================================

5. ìµœì¢… ì„ ì–¸

============================================================

State ë³€ê²½ í†µë¡œëŠ” ë‹¨ í•˜ë‚˜ë‹¤

ëª¨ë“  ì „ëµì€ Signalë¡œë§Œ ë§í•œë‹¤

StateëŠ” ë” ì´ìƒ ë”ëŸ¬ì›Œì§ˆ ìˆ˜ ì—†ë‹¤

ë‹¤ìŒ ë‹¨ê³„ì—ì„œ
Executionì´ ì´ Stateë¥¼ â€œì½ê¸°ë§Œâ€ í•˜ê²Œ ëœë‹¤
